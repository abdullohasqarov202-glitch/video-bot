# telegram_webhook_bot.py
import os
from flask import Flask, request
import telebot
import yt_dlp
import tempfile

# 1Ô∏è‚É£ Telegram token
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
if not TELEGRAM_TOKEN:
    raise RuntimeError("TELEGRAM_TOKEN aniqlanmadi!")

bot = telebot.TeleBot(TELEGRAM_TOKEN)
app = Flask(__name__)

# 2Ô∏è‚É£ Cookie matni ‚Äî shu yerga sizning cookies.txt ichidagi ma‚Äôlumotni joylang
INSTAGRAM_COOKIE = """
# Netscape HTTP Cookie File
# This file is generated by yt-dlp.  Do not edit.
"""  # ‚¨Ü bu joyga brauzerdan eksport qilingan cookie yoziladi

# 3Ô∏è‚É£ Start / help buyrug‚Äòi
@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("üé• Video yuklash", "üì© Admin bilan aloqa", "üé® Rasm yasash")
    bot.send_message(
        message.chat.id,
        "Assalomu alaykum!\nPastdagi tugmalardan birini tanlang:",
        reply_markup=markup
    )

# 4Ô∏è‚É£ Tugma tanlanganda
@bot.message_handler(func=lambda message: message.text == "üì© Admin bilan aloqa")
def contact_admin(message):
    bot.reply_to(message, "Admin bilan aloqa uchun: @Asqarov_0207")

@bot.message_handler(func=lambda message: message.text == "üé® Rasm yasash")
def make_image(message):
    bot.reply_to(message, "‚úçÔ∏è Rasm yaratish xizmati hozircha sinovda ‚Äî tez orada qo‚Äòshiladi!")

@bot.message_handler(func=lambda message: message.text == "üé• Video yuklash")
def ask_video_link(message):
    bot.reply_to(message, "üé• Video havolasini yuboring (Instagram, YouTube va boshqalar).")

# 5Ô∏è‚É£ Video link kelganda yuklab berish
@bot.message_handler(func=lambda message: message.text.startswith("http"))
def download_video(message):
    url = message.text.strip()
    bot.reply_to(message, "‚è≥ Yuklab olinmoqda...")

    try:
        with tempfile.TemporaryDirectory() as tmpdir:
            ydl_opts = {
                'outtmpl': f'{tmpdir}/%(title)s.%(ext)s',
                'cookiefile': 'cookies.txt' if INSTAGRAM_COOKIE.strip() else None,
            }
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(url, download=True)
                video_path = ydl.prepare_filename(info)

            with open(video_path, 'rb') as video:
                bot.send_video(message.chat.id, video)

    except Exception as e:
        bot.reply_to(message, f"‚ùå Xatolik: {e}")

# 6Ô∏è‚É£ Flask webhook yo‚Äòli
@app.route(f'/{TELEGRAM_TOKEN}', methods=['POST'])
def receive_update():
    json_str = request.get_data().decode('utf-8')
    update = telebot.types.Update.de_json(json_str)
    bot.process_new_updates([update])
    return "OK", 200

# 7Ô∏è‚É£ Asosiy ishga tushirish
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)
